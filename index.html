<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Kumar Family Grocery</title>
  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  
  <style>
    :root {
      --veg: #4caf50;
      --gro: #2196f3;
      --ind: #ff9800;
      --oth: #9c27b0;
      --check: #e9ecef;
      --btn2: #f44336;
      --btn3: #4caf50;
      --btn4: #ff5722;
      --h: #fff9c4;
    }
    
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font: 20px 'Segoe UI', sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      margin: 10px 0;
      font-size: 2rem;
      color: #333;
    }
    
    .datetime {
      text-align: center;
      font-size: 1.1rem;
      color: #555;
      margin-top: -5px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .container {
      margin-bottom: 30px;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      font-size: 1.6rem;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
    }
    
    #veggies-header { background: var(--veg); }
    #grocery-header { background: var(--gro); }
    #indian-header { background: var(--ind); }
    #kmart_bigw_target-header { background: var(--oth); }
    #pharmacy-header { background: var(--oth); }
    #others-header { background: var(--oth); }
    
    .collapse-arrow {
      font-size: 2.4rem;
      transition: transform .3s;
      user-select: none;
    }
    
    .collapsed .collapse-arrow {
      transform: rotate(-90deg);
    }
    
    ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    
    li {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      background: #fff;
      font-size: 1.8rem;
    }
    
    li:last-child {
      border-bottom: none;
    }
    
    li.checked {
      background: var(--check);
      color: #666;
    }
    
    li.checked .name {
      background: var(--check);
      text-decoration: line-through;
      opacity: .7;
    }
    
    input[type="checkbox"] {
      width: 28px;
      height: 28px;
      cursor: pointer;
      margin-top: 4px;
      accent-color: #666;
      transition: transform 0.2s;
    }
    
    input[type="checkbox"]:hover {
      transform: scale(1.1);
    }
    
    .name {
      flex: 1;
      min-width: 0;
      font-size: 1.8rem;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: none;
      background: transparent;
      font-family: inherit;
      cursor: text;
      user-select: none;
      transition: all 0.2s;
    }
    
    .name.active {
      background: var(--h);
      font-weight: bold;
      border-radius: 4px;
    }
    
    input.name:focus {
      caret-color: #000;
      outline: none;
    }
    
    input.name {
      user-select: text;
    }
    
    .counter {
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }
    
    .counter.active {
      background: var(--h);
      border-radius: 20px;
      padding: 4px 8px;
    }
    
    .counter button {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      background-color: #bbb;
      transition: all 0.2s;
    }
    
    .counter button:hover {
      transform: scale(1.1);
    }
    
    .counter span.count {
      min-width: 32px;
      text-align: center;
    }
    
    .counter.active span.count {
      font-weight: bold;
    }
    
    li.checked .counter {
      background: var(--check);
      border-radius: 20px;
      padding: 4px 8px;
    }
    
    li.checked .counter span.count,
    li.checked .counter button {
      color: #666;
      opacity: 0.7;
    }
    
    .add-btn {
      display: block;
      margin: 12px 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--veg);
      color: #fff;
      font-size: 1.6rem;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    
    .add-btn:hover {
      transform: scale(1.1);
    }
    
    /* Header counter styles */
    .header-count {
      font-size: 2.3rem;
      background: #fffbe7;
      color: #222;
      padding: 6px 28px;
      border-radius: 22px;
      margin-left: 20px;
      font-weight: 800;
      min-width: 60px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.03em;
      transition: background 0.2s, color 0.2s, font-size 0.2s;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      border: 3px solid #ffcc80;
    }
    
    .header-check {
      font-size: 2.3rem;
      background: #e6f9e6;
      color: #107c41;
      padding: 6px 28px;
      border-radius: 22px;
      margin-left: 20px;
      font-weight: 800;
      min-width: 60px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      letter-spacing: 0.03em;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      border: 3px solid #b2e9b2;
    }
    
    .header-check .checkmark {
      font-size: 2.2rem;
      color: #00a152;
      margin-left: 2px;
      font-weight: bold;
      line-height: 1;
    }
    
    .header-count.zero {
      background: #f5f5f5;
      color: #666;
      font-weight: normal;
      border-color: #bdbdbd;
    }
    
    @media (max-width: 600px) {
      .header-count,
      .header-check {
        font-size: 1.2rem;
        padding: 3px 10px;
        min-width: 32px;
      }
      
      .header-check .checkmark {
        font-size: 1.2rem;
      }
      
      li {
        font-size: 1.35rem;
        padding: 15px 13px 15px 14px;
      }
      
      .name {
        font-size: 1.35rem;
      }
      
      input[type="checkbox"] {
        width: 24px;
        height: 24px;
      }
      
      .counter button {
        width: 28px;
        height: 28px;
        font-size: 1rem;
      }
      
      .counter span.count {
        font-size: 1.35rem;
        min-width: 28px;
      }
    }
    
    /* Top actions bar */
    .top-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .top-actions button {
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    
    .top-actions button:hover {
      transform: scale(1.05);
    }
    
    .reset-btn {
      background: var(--btn2);
    }
    
    .check-zeros-btn {
      background: var(--btn4);
    }
    
    /* Floating reset button */
    .reset-btn-float {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 15px;
      background: var(--btn2);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 100;
      transition: all 0.3s ease;
    }
    
    .reset-btn-float:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    /* Logout button */
    .logout-btn-top {
      position: fixed;
      top: 14px;
      left: 15px;
      z-index: 1301;
      background: #f5f7fa;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 7px rgba(30,30,30,0.10);
      opacity: 0.84;
      transition: background 0.13s, opacity 0.13s;
    }
    
    .logout-btn-top:hover {
      background: #e3e7ee;
      opacity: 1;
    }
    
    .logout-btn-top svg {
      width: 19px;
      height: 19px;
      fill: #444;
    }
    
    /* Add table button */
    .add-table-btn-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    .add-table-btn {
      background: var(--btn3);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 46px;
      height: 46px;
      font-size: 2.1rem;
      box-shadow: 0 3px 14px rgba(0,0,0,0.13);
      cursor: pointer;
      font-weight: 700;
      transition: all 0.2s;
    }
    
    .add-table-btn:hover {
      transform: scale(1.1);
    }
    
    /* Modal styles */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-dialog {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      text-align: center;
    }
    
    .modal-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
    }
    
    .modal-btns {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-btn-no, .modal-btn-yes {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn-no {
      background: #f44336;
      color: white;
    }
    
    .modal-btn-no:hover {
      background: #d32f2f;
    }
    
    .modal-btn-yes {
      background: #4caf50;
      color: white;
    }
    
    .modal-btn-yes:hover {
      background: #388e3c;
    }
    
    /* Input modal */
    .input-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .input-modal-dialog {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      text-align: center;
    }
    
    .input-modal-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
    }
    
    .input-modal-input {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    
    .input-modal-btns {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    .input-modal-btn-cancel, .input-modal-btn-ok {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .input-modal-btn-cancel {
      background: #f44336;
      color: white;
    }
    
    .input-modal-btn-cancel:hover {
      background: #d32f2f;
    }
    
    .input-modal-btn-ok {
      background: #4caf50;
      color: white;
    }
    
    .input-modal-btn-ok:hover {
      background: #388e3c;
    }
  </style>
</head>
<body>
  <!-- Logout button top left -->
  <button class="logout-btn-top" id="logout-btn-top" title="Logout" style="display:none;">
    <svg viewBox="0 0 20 20"><path d="M7.5 3A1.5 1.5 0 0 0 6 4.5v3a1 1 0 1 0 2 0v-3h7v13h-7v-3a1 1 0 1 0-2 0v3A1.5 1.5 0 0 0 7.5 19h7A1.5 1.5 0 0 0 16 17.5v-13A1.5 1.5 0 0 0 14.5 3h-7zm2.79 3.29a1 1 0 1 0-1.42 1.42L10.59 10H2a1 1 0 1 0 0 2h8.59l-1.72 1.29a1 1 0 1 0 1.42 1.42l3.5-3a1 1 0 0 0 0-1.42l-3.5-3z"></path></svg>
  </button>
  <div id="login-section" style="text-align:center;margin-top:50px;">
    <h2>Login to Grocery List</h2>
    <button id="google-signin-btn" style="font-size:1.1rem;padding:10px 22px;background:#4285F4;color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:600;">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="height:1.25em;vertical-align:middle;margin-right:6px;">
      Sign in with Google
    </button>
    <div id="login-error" style="color:red;margin:10px;"></div>
  </div>
  <div id="main-section" style="display:none;">
    <div class="top-actions">
      <button class="reset-btn" id="static-reset-btn" title="Reset counters and uncheck all">
        <span>Reset All</span>
      </button>
      <button class="check-zeros-btn" id="check-zeros-btn" title="Highlight items to buy">
        <span>Check Zeros</span>
      </button>
    </div>
    <button class="reset-btn-float" id="floating-reset-btn" title="Reset counters and uncheck all">
      <svg width="17" height="17" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="#f44336"/><path fill="#fff" d="M6.6 13.2A4.5 4.5 0 0 1 10 6.5c1.2 0 2.3.5 3.1 1.3l-1.1 1.1H16V5.5l-1.4 1.4A6 6 0 1 0 16 10h-1.5a4.5 4.5 0 0 1-7.9 2.7z"/></svg>
    </button>
    <h1>Kumar Family Grocery</h1>
    <div class="datetime" id="datetime"></div>
    <div id="tables-area"></div>
    <div class="add-table-btn-wrap">
      <button class="add-table-btn" onclick="addNewTablePrompt()" data-tooltip="Add Table" title="Add Table">＋</button>
    </div>
  </div>
  <!-- Modal for confirmations -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal-dialog" id="modal-dialog">
      <div class="modal-title" id="modal-title"></div>
      <div class="modal-btns">
        <button class="modal-btn-no" id="modal-btn-no" autofocus>NO</button>
        <button class="modal-btn-yes" id="modal-btn-yes">YES</button>
      </div>
    </div>
  </div>
  <!-- Custom Input Modal -->
  <div class="input-modal-backdrop" id="input-modal-backdrop">
    <div class="input-modal-dialog">
      <div class="input-modal-title" id="input-modal-title"></div>
      <input type="text" id="input-modal-input" class="input-modal-input" autocomplete="off" />
      <div class="input-modal-btns">
        <button class="input-modal-btn input-modal-btn-cancel" id="input-modal-btn-cancel">Cancel</button>
        <button class="input-modal-btn input-modal-btn-ok" id="input-modal-btn-ok">OK</button>
      </div>
    </div>
  </div>
  <script>
    // Allowed users
    const ALLOWED_USERS = [
      "sunil.kumar101@gmail.com",
      "manju4sun@gmail.com"
    ];

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyADHt2ZI5eCYLWs9hA16WJaL16C8REHbMI",
      authDomain: "kumar-grocery-list.firebaseapp.com",
      databaseURL: "https://kumar-grocery-list-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kumar-grocery-list",
      storageBucket: "kumar-grocery-list.appspot.com",
      messagingSenderId: "726095302244",
      appId: "1:726095302244:web:afacaef92680ad26151971",
      measurementId: "G-MC9K47NDW6"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let CATEGORIES = [
      'veggies',
      'grocery',
      'indian',
      'kmart_bigw_target',
      'pharmacy',
      'others'
    ];

    let CATEGORY_NAMES = {
      veggies: 'Veggies',
      grocery: 'Grocery',
      indian: 'India Store',
      kmart_bigw_target: 'Kmart/Big W/Target',
      pharmacy: 'Pharmacy',
      others: 'Others'
    };

    let CATEGORY_ICONS = {
      veggies: '🥦',
      grocery: '🛒',
      indian: '<img src="https://upload.wikimedia.org/wikipedia/en/4/41/Flag_of_India.svg" alt="India" style="height:1.3em;vertical-align:middle;margin-right:4px;">',
      kmart_bigw_target: '',
      pharmacy: '',
      others: ''
    };

    let CATEGORY_HEADER_CLASSES = {
      veggies: 'veggies-header',
      grocery: 'grocery-header',
      indian: 'indian-header',
      kmart_bigw_target: 'kmart_bigw_target-header',
      pharmacy: 'pharmacy-header',
      others: 'others-header'
    };

    let groceryData = {};
    let listeners = [];
    // For check zeros mode
    let checkZerosActive = false;
    let originalKeyOrder = {};

    // Google Auth
    function googleSignIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          if (ALLOWED_USERS.length && !ALLOWED_USERS.includes(user.email)) {
            auth.signOut();
            document.getElementById('login-error').textContent = 'Access denied. Please use an allowed Google account.';
            return;
          }
          showMain();
          subscribeAllLists();
        })
        .catch((err) => {
          document.getElementById('login-error').textContent = err.message;
        });
    }
    document.getElementById('google-signin-btn').onclick = googleSignIn;

    // Custom input modal for modern UI prompts
    function showInputModal(title, placeholder, callback) {
      const backdrop = document.getElementById('input-modal-backdrop');
      const titleEl = document.getElementById('input-modal-title');
      const input = document.getElementById('input-modal-input');
      const btnCancel = document.getElementById('input-modal-btn-cancel');
      const btnOK = document.getElementById('input-modal-btn-ok');

      titleEl.textContent = title;
      input.value = '';
      input.placeholder = placeholder || '';
      backdrop.classList.add('active');

      setTimeout(() => { input.focus(); }, 50);

      function cleanup() {
        backdrop.classList.remove('active');
        btnCancel.onclick = null;
        btnOK.onclick = null;
        input.onkeydown = null;
      }

      btnCancel.onclick = () => { cleanup(); callback(false); };
      btnOK.onclick = () => {
        cleanup();
        callback(input.value.trim());
      };
      input.onkeydown = (e) => {
        if (e.key === "Enter") { btnOK.click(); }
        if (e.key === "Escape") { btnCancel.click(); }
      };
    }

    // Logout logic and clearing stale data
    function clearAllCookies() {
      const cookies = document.cookie.split("; ");
      for (let c of cookies) {
        const eqPos = c.indexOf("=");
        const name = eqPos > -1 ? c.substring(0, eqPos) : c;
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;";
      }
    }

    function logout() {
      listeners.forEach(fn => {try {fn();}catch(e){}});
      listeners = [];
      auth.signOut().finally(() => {
        clearAllCookies();
        localStorage.clear();
        sessionStorage.clear();
        location.reload();
      });
    }

    // Logout icon confirmation modal
    document.getElementById('logout-btn-top').onclick = function() {
      showModal("Are you sure you want to logout?", function(yes) {
        if (yes) logout();
      });
    };

    // Show/hide logout button depending on login state
    function setLogoutButtonVisible(visible) {
      var btn = document.getElementById('logout-btn-top');
      if (btn) btn.style.display = visible ? '' : 'none';
    }

    function showMain() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('main-section').style.display = '';
      setLogoutButtonVisible(true);
      CATEGORIES.forEach(cat=>{
        if(localStorage.getItem('col-'+cat)==='true') setCollapsed(cat,true);
      });
    }
    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent =
        now.toLocaleString('en-AU', {weekday:'long',year:'numeric',month:'short',day:'numeric', hour:'2-digit',minute:'2-digit', second:'2-digit', hour12:true});
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Listeners
    function subscribeAllLists() {
      listeners.forEach(fn => {try {fn();}catch(e){}});
      listeners = [];
      db.ref(`/groceryLists`).on('value', snap => {
        const data = snap.val() || {};
        groceryData = data;
        // Save original order for each category (first load only)
        Object.entries(data).forEach(([cat, items]) => {
          if (!originalKeyOrder[cat] && items) {
            originalKeyOrder[cat] = Object.keys(items);
          }
        });
        let allKeys = Object.keys(data);
        let ordered = [];
        CATEGORIES.forEach(cat => { if(allKeys.includes(cat)) ordered.push(cat); });
        allKeys.forEach(cat=>{
          if(!ordered.includes(cat)) ordered.push(cat);
        });
        CATEGORIES = ordered;
        renderAllTables();
      });
      CATEGORIES.forEach(cat => {
        const ref = db.ref(`/groceryLists/${cat}`);
        const fn = ref.on('value', snap => {
          groceryData[cat] = snap.val() || {};
          renderList(cat);
          updateHeaderCount(cat);
        });
        listeners.push(() => ref.off('value', fn));
      });
    }

    // Modal helpers
    function showModal(title, callback) {
      const backdrop = document.getElementById('modal-backdrop');
      const titleEl = document.getElementById('modal-title');
      const btnNo = document.getElementById('modal-btn-no');
      const btnYes = document.getElementById('modal-btn-yes');
      titleEl.textContent = title;
      backdrop.classList.add('active');
      btnNo.focus();
      function cleanup() {
        backdrop.classList.remove('active');
        btnNo.onclick = null;
        btnYes.onclick = null;
      }
      btnNo.onclick = ()=>{ cleanup(); callback(false); };
      btnYes.onclick = ()=>{ cleanup(); callback(true); };
    }

    // Render all tables
    function renderAllTables() {
      const area = document.getElementById('tables-area');
      area.innerHTML = '';
      CATEGORIES.forEach(cat => {
        if (!CATEGORY_NAMES[cat]) CATEGORY_NAMES[cat] = cat.charAt(0).toUpperCase() + cat.slice(1);
        if (!CATEGORY_ICONS[cat]) CATEGORY_ICONS[cat] = '';
        const container = document.createElement('div');
        container.className = 'container';
        container.id = `${cat}-container`;

        // Header
        const header = document.createElement('div');
        header.className = 'header ' + (CATEGORY_HEADER_CLASSES[cat] || 'default-header');
        header.id = `${cat}-header`;
        header.onclick = ()=>toggleCollapse(cat);

        // Long press to delete table
        let headerPressTimer = null;
        header.addEventListener('touchstart', e => {
          headerPressTimer = setTimeout(()=>{
            showModal(`Delete "${CATEGORY_NAMES[cat]}" and all its items?`, (yes) => {
              if(yes) deleteTable(cat);
            });
          }, 2000);
        });
        header.addEventListener('touchend', e => {clearTimeout(headerPressTimer);});
        header.addEventListener('touchmove', e => {clearTimeout(headerPressTimer);});
        header.addEventListener('mousedown', e => {
          if(e.button!==0) return;
          headerPressTimer = setTimeout(()=>{
            showModal(`Delete "${CATEGORY_NAMES[cat]}" and all its items?`, (yes) => {
              if(yes) deleteTable(cat);
            });
          }, 2000);
        });
        header.addEventListener('mouseup', e => {clearTimeout(headerPressTimer);});
        header.addEventListener('mouseleave', e => {clearTimeout(headerPressTimer);});

        const headerTitle = document.createElement('span');
        headerTitle.className = 'header-title';
        headerTitle.innerHTML = (CATEGORY_ICONS[cat] ? CATEGORY_ICONS[cat] + " " : "") + CATEGORY_NAMES[cat];

        const headerCount = document.createElement('span');
        headerCount.className = 'header-count';
        headerCount.id = `${cat}-count`;

        const headerArrow = document.createElement('span');
        headerArrow.className = 'collapse-arrow';
        headerArrow.id = `${cat}-arrow`;
        headerArrow.innerHTML = "▾";

        header.appendChild(headerTitle);
        header.appendChild(headerCount);
        header.appendChild(headerArrow);

        container.appendChild(header);

        // List
        const ul = document.createElement('ul');
        ul.id = cat;
        container.appendChild(ul);

        // Add item button
        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = '＋';
        addBtn.onclick = (e)=>{
          e.stopPropagation();
          addItem(cat);
        };
        container.appendChild(addBtn);

        area.appendChild(container);

        if(localStorage.getItem('col-'+cat)==='true') setCollapsed(cat,true);

        renderList(cat);
        updateHeaderCount(cat);
      });
    }

    function deleteTable(cat) {
      db.ref(`/groceryLists/${cat}`).remove();
      setTimeout(renderAllTables, 300);
    }

    // Collapse logic
    function toggleCollapse(cat) {
      const ul = document.getElementById(cat);
      const addBtn = document.querySelector(`#${cat}-container .add-btn`);
      const container = document.getElementById(cat+'-container');
      let collapsed = ul.style.display!=='none';
      setCollapsed(cat, collapsed);
      localStorage.setItem('col-'+cat, collapsed?'true':'');
    }
    function setCollapsed(cat, collapsed) {
      const ul = document.getElementById(cat);
      const addBtn = document.querySelector(`#${cat}-container .add-btn`);
      const container = document.getElementById(cat+'-container');
      if (!ul || !addBtn || !container) return;
      ul.style.display = collapsed?'none':'';
      addBtn.style.display = collapsed?'none':'';
      container.classList.toggle('collapsed', collapsed);
    }

    // Render List
    function renderList(cat) {
      const ul = document.getElementById(cat);
      if (!ul) return;
      ul.innerHTML = '';

      let items = groceryData[cat] || {};
      let keys = Object.keys(items);

      // If check-zeros mode is active, sort: count>0 first (maintain order), then count==0 (maintain order)
      if (checkZerosActive && originalKeyOrder[cat]) {
        const origOrder = originalKeyOrder[cat].slice(); // snapshot
        keys.sort((a,b)=>{
          const ia = items[a]?.count>0 ? 0 : 1;
          const ib = items[b]?.count>0 ? 0 : 1;
          if (ia !== ib) return ia-ib;
          // maintain original order within each group
          return origOrder.indexOf(a) - origOrder.indexOf(b);
        });
      } else if (originalKeyOrder[cat]) {
        // Always show in original order if not sorting
        keys = originalKeyOrder[cat].slice();
      }

      keys.forEach(key => {
        const item = items[key];
        if (!item || typeof item !== 'object' || typeof item.name !== 'string') return;
        const li = document.createElement('li');
        li.setAttribute('draggable', 'false');
        if(item.checked) li.classList.add('checked');
        if(item.count > 0) li.classList.add('has-count');
        li.style.position = 'relative';

        // Long press to delete row
        let rowPressTimer = null;
        li.addEventListener('touchstart', e => {
          rowPressTimer = setTimeout(()=>{
            showModal(`Delete item "${item.name}" from "${CATEGORY_NAMES[cat]}"?`, (yes) => {
              if(yes) deleteRow(cat, key);
            });
          }, 2000);
        });
        li.addEventListener('touchend', e => {clearTimeout(rowPressTimer);});
        li.addEventListener('touchmove', e => {clearTimeout(rowPressTimer);});
        li.addEventListener('mousedown', e => {
          if(e.button!==0) return;
          rowPressTimer = setTimeout(()=>{
            showModal(`Delete item "${item.name}" from "${CATEGORY_NAMES[cat]}"?`, (yes) => {
              if(yes) deleteRow(cat, key);
            });
          }, 2000);
        });
        li.addEventListener('mouseup', e => {clearTimeout(rowPressTimer);});
        li.addEventListener('mouseleave', e => {clearTimeout(rowPressTimer);});

        // Checkbox
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!item.checked;
        cb.onchange = () => toggleChecked(cat, key, cb.checked);
        li.appendChild(cb);

        // Name (edit on double click)
        const name = document.createElement('div');
        name.className = 'name' + (item.count > 0 ? ' active' : '');
        name.textContent = item.name;
        name.ondblclick = (e) => {
          e.stopPropagation();
          editNameInline(cat, key, name, item);
        };
        li.appendChild(name);

        // Counter
        const cnt = document.createElement('div');
        cnt.className = 'counter' + (item.count > 0 ? ' active' : '');
        const minus = document.createElement('button');
        minus.textContent = '-';
        minus.onclick = (e) => {
          e.stopPropagation();
          updateCount(cat, key, -1);
        };
        const count = document.createElement('span');
        count.className = 'count';
        count.textContent = item.count || 0;
        const plus = document.createElement('button');
        plus.textContent = '+';
        plus.onclick = (e) => {
          e.stopPropagation();
          updateCount(cat, key, +1);
        };
        cnt.appendChild(minus);
        cnt.appendChild(count);
        cnt.appendChild(plus);
        li.appendChild(cnt);

        ul.appendChild(li);
      });
    }

    function deleteRow(cat, key) {
      db.ref(`/groceryLists/${cat}/${key}`).remove();
      setTimeout(()=>renderList(cat), 300);
    }

    // Modern UI for add item
    function addItem(cat) {
      showInputModal('Enter new item name:', 'e.g. Carrots', function(name) {
        if(!name) return;
        db.ref(`/groceryLists/${cat}`).push({name: name, count: 0, checked: false});
      });
    }

    // Modern UI for add table
    function addNewTablePrompt() {
      showInputModal('Enter table name (e.g. Pharmacy):', 'e.g. Pharmacy', function(tname) {
        if(!tname) return;
        tname = tname.trim();
        let catKey = tname.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
        if (!catKey) catKey = 'custom_' + Date.now();
        if(CATEGORIES.includes(catKey)) {
          alert('Table already exists!');
          return;
        }
        let items = {};
        showInputModal('Add an item to this table now? (Optional)', 'First item name', function(itemName) {
          if(itemName && itemName.trim()) {
            items = {[db.ref().push().key]: {name:itemName.trim(), count:0, checked:false}};
          }
          CATEGORY_NAMES[catKey] = tname;
          CATEGORY_ICONS[catKey] = '';
          CATEGORY_HEADER_CLASSES[catKey] = 'default-header';
          db.ref(`/groceryLists/${catKey}`).set(items);
        });
      });
    }

    function updateCount(cat, key, delta) {
      const item = groceryData[cat][key];
      if (!item || typeof item !== 'object' || typeof item.name !== 'string') return;
      let v = (item.count || 0) + delta;
      v = Math.max(0, Math.min(50, v));
      db.ref(`/groceryLists/${cat}/${key}`).update({ count: v });
    }

    function toggleChecked(cat, key, val) {
      db.ref(`/groceryLists/${cat}/${key}`).update({ checked: !!val });
    }

    function editNameInline(cat, key, nameDiv, oldItem) {
      if(nameDiv.classList.contains('editing')) return;
      const prevName = oldItem.name;
      nameDiv.classList.add('editing');
      nameDiv.setAttribute('contenteditable', 'true');
      nameDiv.setAttribute('spellcheck', 'false');
      nameDiv.style.userSelect = "text";
      nameDiv.focus();
      nameDiv.setSelectionRange && nameDiv.setSelectionRange(prevName.length, prevName.length);

      let finished = false;

      function finishEdit() {
        if (finished) return;
        finished = true;
        nameDiv.classList.remove('editing');
        nameDiv.removeAttribute('contenteditable');
        nameDiv.style.userSelect = "";
        const newValue = nameDiv.textContent.trim();
        if (!newValue) {
          db.ref(`/groceryLists/${cat}/${key}`).update({ name: prevName });
          nameDiv.textContent = prevName;
        } else if (newValue !== prevName) {
          db.ref(`/groceryLists/${cat}/${key}`).update({ name: newValue });
        }
      }
      nameDiv.onkeydown = function(e) {
        if (e.key === "Enter") { e.preventDefault(); finishEdit(); }
        if (e.key === "Escape") { nameDiv.textContent = prevName; finishEdit(); }
      };
      nameDiv.onblur = finishEdit;
    }

    // RESET ALL: Uncheck all, set count=0, restore order
    function resetAll() {
      showModal("Reset all counters to 0 and uncheck all items in all tables?", function(yes) {
        if (!yes) return;
        checkZerosActive = false;
        CATEGORIES.forEach(cat => {
          const items = groceryData[cat] || {};
          Object.entries(items).forEach(([key, item]) => {
            if (item && typeof item === 'object') {
              db.ref(`/groceryLists/${cat}/${key}`).update({
                count: 0,
                checked: false
              });
            }
          });
        });
        setTimeout(() => {
          renderAllTables();
        }, 350);
      });
    }

    // "Check Zeros": check all items with count==0, sort count>0 to top, count==0 to bottom
    function checkZeros() {
      checkZerosActive = true;
      CATEGORIES.forEach(cat=>{
        const items = groceryData[cat] || {};
        Object.entries(items).forEach(([key, item]) => {
          if(item.count==0 && !item.checked) {
            db.ref(`/groceryLists/${cat}/${key}`).update({checked:true});
          }
        });
      });
      setTimeout(()=>{
        renderAllTables();
      }, 350);
    }

    // Handle static and floating reset/check buttons
    document.getElementById('static-reset-btn').onclick = resetAll;
    document.getElementById('floating-reset-btn').onclick = resetAll;
    document.getElementById('check-zeros-btn').onclick = checkZeros;

    function updateHeaderCount(cat){
      const items = groceryData[cat] || {};
      const count = Object.values(items).filter(x=>x && typeof x === "object" && !x.checked && x.count>0).length;
      const total = Object.values(items).filter(x=>x && typeof x === "object" && x.count>0).length;
      const el = document.getElementById(cat+'-count');
      if(!el) return;
      
      if (total === 0) {
        el.textContent = "0";
        el.className = 'header-count zero';
      } else if (count === 0) {
        el.innerHTML = '<span class="checkmark">✓</span>';
        el.className = 'header-check';
      } else {
        el.textContent = count;
        el.className = 'header-count';
      }
    }

    auth.onAuthStateChanged(user => {
      if (user && (!ALLOWED_USERS.length || ALLOWED_USERS.includes(user.email))) {
        showMain();
        subscribeAllLists();
      } else {
        document.getElementById('main-section').style.display = 'none';
        document.getElementById('login-section').style.display = '';
        setLogoutButtonVisible(false);
      }
    });
  </script>
</body>
</html>
