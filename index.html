<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Kumar Family Grocery</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    body{font:20px 'Segoe UI',sans-serif;background:#f5f7fa;padding:20px}
    h1{text-align:center;margin:10px 0;font-size:2rem;color:#333;position:relative;}
    #logout-btn{position:absolute;top:18px;right:18px;background:none;border:none;font-size:1.1rem;cursor:pointer;opacity:0.6;}
    #logout-btn:hover{opacity:1;}
    .datetime{font-size:1rem;color:#888;text-align:center;margin-bottom:18px;}
    .reset-btn-float{position:fixed;top:22px;right:55px;z-index:999;background:#f44336;color:#fff;border:none;border-radius:50px;padding:7px 16px;font-size:1.1rem;box-shadow:0 3px 10px rgba(0,0,0,0.14);cursor:pointer;font-weight:600;}
    .container{margin-bottom:30px;background:#fff;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
    .header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;font-size:1.45rem;font-weight:700;color:#fff;cursor:pointer;}
    #veggies-header{background:#4caf50} #grocery-header{background:#2196f3} #indian-header{background:#ff9800} #others-header{background:#9c27b0}
    #kmart-header{background:#00897b}
    .header-count{font-size:1.7rem;font-weight:900;background:rgba(255,255,255,0.83);color:#222;padding:2px 18px;border-radius:22px;margin-left:10px;min-width:40px;text-align:center;}
    .header-check{font-size:2.0rem;font-weight:900;color:#fff;background:rgba(16,157,57,0.92);padding:2px 16px;border-radius:22px;margin-left:10px;min-width:40px;display:inline-block;text-align:center;}
    .collapse-arrow{margin-left:10px;font-size:1.5rem;transition:transform 0.18s;}
    .collapsed .collapse-arrow{transform:rotate(-90deg);}
    ul{list-style:none;margin:0;padding:0}
    li{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid #eee;background:#fff;font-size:1.15rem;user-select:none;transition:background .2s;}
    li:last-child{border-bottom:none}
    li.checked{background:#e9ecef;color:#666}
    input[type="checkbox"]{width:22px;height:22px;cursor:pointer;margin-top:2px;accent-color:#666;}
    .name{flex:1;min-width:0;font-size:1.13rem;line-height:1.3;border:none;background:transparent;outline:none;padding:0;transition:background 0.15s;}
    .name.editing{background:#fffbe9;border-radius:5px;}
    .counter{display:flex;align-items:center;gap:7px;}
    .counter button{width:25px;height:25px;border:none;border-radius:50%;color:#fff;font-size:1.1rem;cursor:pointer;background-color:#bbb;}
    .counter span.count{min-width:21px;text-align:center}
    .add-btn{margin:12px 16px 12px 16px;width:34px;height:34px;border-radius:50%;background:#4caf50;color:#fff;font-size:1.3rem;cursor:pointer;border:none;}
    .swipe-delete{position:absolute;right:0;top:0;bottom:0;width:85px;display:flex;align-items:center;justify-content:center;background:#f44336;color:#fff;font-size:1.2rem;border-radius:0 8px 8px 0;opacity:0;transition:opacity 0.15s;}
    li.swiped .swipe-delete{opacity:1;}
    li.dragging{opacity:0.5;}
    @media(max-width:600px){
      .header{font-size:1.09rem;}
      .name{font-size:1rem;}
      .header-count{font-size:1.2rem;padding:2px 8px;}
      .header-check{font-size:1.3rem;padding:2px 8px;}
      .reset-btn-float{padding:7px 10px;font-size:0.9rem;}
    }
  </style>
</head>
<body>
  <div id="login-section" style="text-align:center;margin-top:50px;">
    <h2>Login to Grocery List</h2>
    <input type="text" id="phone-number" placeholder="+614XXXXXXXX" style="font-size:1.2rem;padding:8px;width:220px;">
    <button onclick="sendOTP()">Send OTP</button>
    <div id="recaptcha-container"></div>
    <div id="otp-section" style="display:none;margin-top:15px;">
      <input type="text" id="otp-code" placeholder="Enter OTP" style="font-size:1.2rem;padding:8px;width:160px;">
      <button onclick="verifyOTP()">Verify OTP</button>
    </div>
    <div id="login-error" style="color:red;margin:10px;"></div>
  </div>
  <div id="main-section" style="display:none;">
    <button id="logout-btn" title="Logout" onclick="logout()">
      <svg width="16" height="16" viewBox="0 0 20 20" style="vertical-align:middle;"><path fill="#5b5b5b" d="M3 2a2 2 0 0 1 2-2h5a2 2 0 0 1 2 2v3h-2V2H5v16h5v-3h2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V2zm11.29 7.29l-1.3 1.3a1 1 0 1 0 1.42 1.42l3-3a1 1 0 0 0 0-1.42l-3-3a1 1 0 0 0-1.42 1.42l1.3 1.3H9a1 1 0 1 0 0 2h5.59z"/></svg>
    </button>
    <button class="reset-btn-float" onclick="resetAll()" title="Reset counters and uncheck all">Reset All</button>
    <h1>Kumar Family Grocery</h1>
    <div class="datetime" id="datetime"></div>
    <div class="container" id="veggies-container">
      <div id="veggies-header" class="header" onclick="toggleCollapse('veggies')">
        <span>ðŸ¥¦ Veggies</span>
        <span class="header-count" id="veggies-count"></span>
        <span class="collapse-arrow" id="veggies-arrow">&#9654;</span>
      </div>
      <ul id="veggies"></ul>
      <button class="add-btn" onclick="addItem('veggies')">ï¼‹</button>
    </div>
    <div class="container" id="grocery-container">
      <div id="grocery-header" class="header" onclick="toggleCollapse('grocery')">
        <span>ðŸ›’ Grocery</span>
        <span class="header-count" id="grocery-count"></span>
        <span class="collapse-arrow" id="grocery-arrow">&#9654;</span>
      </div>
      <ul id="grocery"></ul>
      <button class="add-btn" onclick="addItem('grocery')">ï¼‹</button>
    </div>
    <div class="container" id="indian-container">
      <div id="indian-header" class="header" onclick="toggleCollapse('indian')">
        <span><img src="https://upload.wikimedia.org/wikipedia/en/4/41/Flag_of_India.svg" alt="India" style="height:1.3em;vertical-align:middle;margin-right:4px;">India Store</span>
        <span class="header-count" id="indian-count"></span>
        <span class="collapse-arrow" id="indian-arrow">&#9654;</span>
      </div>
      <ul id="indian"></ul>
      <button class="add-btn" onclick="addItem('indian')">ï¼‹</button>
    </div>
    <div class="container" id="others-container">
      <div id="others-header" class="header" onclick="toggleCollapse('others')">
        <span>Bunnings/Kmart/BigW</span>
        <span class="header-count" id="others-count"></span>
        <span class="collapse-arrow" id="others-arrow">&#9654;</span>
      </div>
      <ul id="others"></ul>
      <button class="add-btn" onclick="addItem('others')">ï¼‹</button>
    </div>
    <div class="container" id="kmart-container">
      <div id="kmart-header" class="header" onclick="toggleCollapse('kmart_bigw_target')">
        <span>Kmart/Big W/Target</span>
        <span class="header-count" id="kmart_bigw_target-count"></span>
        <span class="collapse-arrow" id="kmart_bigw_target-arrow">&#9654;</span>
      </div>
      <ul id="kmart_bigw_target"></ul>
      <button class="add-btn" onclick="addItem('kmart_bigw_target')">ï¼‹</button>
    </div>
  </div>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyADHt2ZI5eCYLWs9hA16WJaL16C8REHbMI",
      authDomain: "kumar-grocery-list.firebaseapp.com",
      databaseURL: "https://kumar-grocery-list-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kumar-grocery-list",
      storageBucket: "kumar-grocery-list.appspot.com",
      messagingSenderId: "726095302244",
      appId: "1:726095302244:web:afacaef92680ad26151971",
      measurementId: "G-MC9K47NDW6"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const ALLOWED_PHONES = [
      "+61455178635",
      "+61472504905",
      "+61460028100"
    ];
    const CATEGORIES = ['veggies', 'grocery', 'indian', 'others', 'kmart_bigw_target'];
    let groceryData = {};
    CATEGORIES.forEach(cat=>{groceryData[cat]={};});
    let listeners = [];

    // OTP Auth
    let confirmationResult = null;
    function sendOTP() {
      const phone = document.getElementById('phone-number').value.trim();
      let phoneE164 = phone.startsWith('+') ? phone : '+'+phone;
      if (!ALLOWED_PHONES.includes(phoneE164)) {
        document.getElementById('login-error').textContent = 'This number is not allowed.';
        return;
      }
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {size: 'invisible'});
      auth.signInWithPhoneNumber(phoneE164, window.recaptchaVerifier)
        .then((result) => {
          confirmationResult = result;
          document.getElementById('otp-section').style.display = '';
          document.getElementById('login-error').textContent = 'OTP sent!';
        })
        .catch((err) => {
          document.getElementById('login-error').textContent = err.message;
        });
    }
    function verifyOTP() {
      const code = document.getElementById('otp-code').value.trim();
      if (!confirmationResult) return;
      confirmationResult.confirm(code)
        .then((result) => {
          const user = result.user;
          if (!ALLOWED_PHONES.includes(user.phoneNumber)) {
            auth.signOut();
            document.getElementById('login-error').textContent = 'Access denied.';
            return;
          }
          showMain();
          subscribeAllLists();
        })
        .catch((err) => {
          document.getElementById('login-error').textContent = 'Wrong OTP.';
        });
    }
    function logout() {
      listeners.forEach(fn => {try {fn();}catch(e){}});
      listeners = [];
      auth.signOut();
      location.reload();
    }
    function showMain() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('main-section').style.display = '';
      CATEGORIES.forEach(cat=>{
        if(localStorage.getItem('col-'+cat)==='true') setCollapsed(cat,true);
      });
    }
    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent =
        now.toLocaleString('en-AU', {weekday:'long',year:'numeric',month:'short',day:'numeric', hour:'2-digit',minute:'2-digit', second:'2-digit', hour12:true});
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Listeners
    function subscribeAllLists() {
      listeners.forEach(fn => {try {fn();}catch(e){}});
      listeners = [];
      CATEGORIES.forEach(cat => {
        const ref = db.ref(`/groceryLists/${cat}`);
        const fn = ref.on('value', snap => {
          groceryData[cat] = snap.val() || {};
          renderList(cat);
          updateHeaderCount(cat);
        });
        listeners.push(() => ref.off('value', fn));
      });
    }
    // Collapse logic
    function toggleCollapse(cat) {
      const ul = document.getElementById(cat);
      const addBtn = document.querySelector(`#${cat}-container .add-btn`);
      const container = document.getElementById(cat+'-container');
      let collapsed = ul.style.display!=='none';
      setCollapsed(cat, collapsed);
      localStorage.setItem('col-'+cat, collapsed?'true':'');
    }
    function setCollapsed(cat, collapsed) {
      const ul = document.getElementById(cat);
      const addBtn = document.querySelector(`#${cat}-container .add-btn`);
      const container = document.getElementById(cat+'-container');
      ul.style.display = collapsed?'none':'';
      addBtn.style.display = collapsed?'none':'';
      container.classList.toggle('collapsed', collapsed);
    }

    // Render List
    function renderList(cat) {
      const ul = document.getElementById(cat);
      ul.innerHTML = '';
      const items = groceryData[cat] || {};
      Object.entries(items).forEach(([key, item]) => {
        if (!item || typeof item !== 'object' || typeof item.name !== 'string') return;
        const li = document.createElement('li');
        li.setAttribute('draggable', 'false');
        if(item.checked) li.classList.add('checked');
        li.style.position = 'relative';

        // Checkbox
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!item.checked;
        cb.onchange = () => toggleChecked(cat, key, cb.checked);
        li.appendChild(cb);

        // Name (edit on double click)
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = item.name;
        name.ondblclick = () => editNameInline(cat, key, name, item);
        li.appendChild(name);

        // Counter
        const cnt = document.createElement('div');
        cnt.className = 'counter';
        const minus = document.createElement('button');
        minus.textContent = '-';
        minus.onclick = (e) => {
          e.stopPropagation();
          updateCount(cat, key, -1);
        };
        const count = document.createElement('span');
        count.className = 'count';
        count.textContent = item.count || 0;
        const plus = document.createElement('button');
        plus.textContent = '+';
        plus.onclick = (e) => {
          e.stopPropagation();
          updateCount(cat, key, +1);
        };
        cnt.appendChild(minus);
        cnt.appendChild(count);
        cnt.appendChild(plus);
        li.appendChild(cnt);

        // Swipe Delete area (hidden until swipe)
        // If you want to add delete back, add an explicit removeItem handler here

        ul.appendChild(li);
      });
    }

    function addItem(cat) {
      const name = prompt('Enter new item name:');
      if(!name || !name.trim()) return;
      db.ref(`/groceryLists/${cat}`).push({name: name.trim(), count: 0, checked: false});
    }

    // Safe update for plus/minus counter
    function updateCount(cat, key, delta) {
      // Read current value from cached data, then update in db
      const item = groceryData[cat][key];
      if (!item || typeof item !== 'object' || typeof item.name !== 'string') return;
      let v = (item.count || 0) + delta;
      v = Math.max(0, Math.min(50, v));
      db.ref(`/groceryLists/${cat}/${key}`).update({ count: v });
    }

    function toggleChecked(cat, key, val) {
      db.ref(`/groceryLists/${cat}/${key}`).update({ checked: !!val });
    }

    // --- THE KEY FIX: do not allow deletion on blank name during inline edit ---
    function editNameInline(cat, key, nameDiv, oldItem) {
      if(nameDiv.classList.contains('editing')) return;
      const prevName = oldItem.name;
      nameDiv.classList.add('editing');
      const input = document.createElement('input');
      input.type = "text";
      input.value = prevName;
      input.className = "name editing";
      input.style.width = "95%";
      nameDiv.replaceWith(input);
      input.focus();
      input.setSelectionRange(input.value.length, input.value.length);
      let finished = false;
      input.onkeydown = function(e) {
        if (e.key === "Enter") finishEdit();
        if (e.key === "Escape") cancelEdit();
      };
      input.onblur = finishEdit;
      function finishEdit() {
        if (finished) return;
        finished = true;
        const newValue = input.value.trim();
        if (!newValue) {
          // Don't delete, just revert to previous name visually
          db.ref(`/groceryLists/${cat}/${key}`).update({ name: prevName });
        } else if (newValue !== prevName) {
          db.ref(`/groceryLists/${cat}/${key}`).update({ name: newValue });
        } else {
          renderList(cat);
        }
      }
      function cancelEdit() {
        if (finished) return;
        finished = true;
        renderList(cat);
      }
    }

    function resetAll() {
      if(!confirm("Reset all counters to 0 and uncheck all items in all tables?")) return;
      CATEGORIES.forEach(cat=>{
        const items = groceryData[cat] || {};
        Object.entries(items).forEach(([key, item]) => {
          db.ref(`/groceryLists/${cat}/${key}`).update({count:0, checked:false});
        });
      });
    }
    function updateHeaderCount(cat){
      const items = groceryData[cat] || {};
      const count = Object.values(items).filter(x=>x && typeof x === "object" && !x.checked && x.count>0).length;
      const el = document.getElementById(cat+'-count');
      if(!el) return;
      if(count>0) {
        el.textContent = count;
        el.className = 'header-count';
      } else {
        el.innerHTML = '<span class="header-check">&#10003;</span>';
        el.className = '';
      }
    }

    auth.onAuthStateChanged(user => {
      if (user && ALLOWED_PHONES.includes(user.phoneNumber)) {
        showMain();
        subscribeAllLists();
      } else {
        document.getElementById('main-section').style.display = 'none';
        document.getElementById('login-section').style.display = '';
      }
    });
  </script>
</body>
</html>
