<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Kumar Family Grocery</title>
  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    body{
      font:15px 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background:#f5f7fa;
      padding:20px;
    }
    h1{
      text-align:center;
      margin:10px 0;
      font-size:1.7rem;
      color:#333;
      position:relative;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
    }
    #logout-btn{
      position:absolute;
      top:18px;
      right:18px;
      background:none;
      border:none;
      font-size:1.1rem;
      cursor:pointer;
      opacity:0.6;
    }
    #logout-btn:hover{opacity:1;}
    .datetime{
      font-size:1rem;
      color:#888;
      text-align:center;
      margin-bottom:18px;
    }
    .reset-btn-float{
      position:fixed;
      top:22px;
      right:55px;
      z-index:999;
      background:#f44336;
      color:#fff;
      border:none;
      border-radius:50px;
      padding:7px 16px;
      font-size:1.1rem;
      box-shadow:0 3px 10px rgba(0,0,0,0.14);
      cursor:pointer;
      font-weight:600;
    }
    .reset-btn-float:hover{background:#c62828;}
    .container{
      margin-bottom:30px;
      background:#fff;
      border-radius:6px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    .header {
      display:flex;
      flex-direction:row;
      align-items:center;
      padding:7px 14px 7px 16px;
      font-size:1.06rem;
      font-weight:700;
      color:#fff;
      cursor:pointer;
      min-height:32px;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
    }
    .veggies-header { background: #388e3c; }
    .grocery-header { background: #1976d2; }
    .indian-header  { background: #ff9800; }
    .kmart_bigw_target-header { background: #9c27b0; }
    .pharmacy-header { background: #00897b; }
    .others-header { background: #607d8b; }
    .default-header { background: #607d8b; }
    .header-title{
      flex:0 0 auto;
      font-size:1.09rem;
      margin-right:6px;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      color: #fff;
    }
    .header-count{
      font-size:1.12rem;
      font-weight:900;
      background:rgba(255,255,255,0.87);
      color:#222;
      padding:2px 13px;
      border-radius:22px;
      margin-left:3px;
      min-width:28px;
      text-align:center;
      display:inline-block;
      vertical-align:middle;
    }
    .header-check{
      font-size:1.2rem;
      font-weight:900;
      color:#fff;
      background:rgba(16,157,57,0.92);
      padding:2px 10px;
      border-radius:22px;
      margin-left:6px;
      min-width:22px;
      display:inline-block;
      text-align:center;
    }
    .collapse-arrow{
      margin-left:auto;
      font-size:1.1rem;
      transition:transform 0.18s;
      display:inline-block;
    }
    .collapsed .collapse-arrow{transform:rotate(-90deg);}
    ul{list-style:none;margin:0;padding:0}
    li{
      display:flex;
      align-items:center;
      gap:10px;
      padding:13px 16px;
      border-bottom:1px solid #eee;
      background:#fff;
      font-size:1.14rem;
      user-select:none;
      transition:background .2s;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
    }
    li:last-child{border-bottom:none}
    li.checked{
      background:#e0e0e0 !important;
      color:#444 !important;
    }
    input[type="checkbox"]{width:18px;height:18px;cursor:pointer;margin-top:2px;accent-color:#666;}
    .name{
      flex:1;
      min-width:0;
      font-size:1.09rem;
      line-height:1.3;
      border:none;
      background:transparent;
      outline:none;
      padding:0;
      transition:background 0.15s;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      font-weight: normal;
      color: #222;
      user-select: none;
    }
    .name.editing{
      background:#fffbe9;
      border-radius:5px;
      user-select: text;
    }
    li.has-count > .name, li.has-count .name {
      font-weight: bold !important;
      color: #222 !important;
      background: #fff59d !important;
      border-radius: 5px !important;
      padding: 2px 8px !important;
      font-size: 1.09rem !important;
      letter-spacing: 0.01em !important;
      transition: background 0.15s, color 0.15s;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
    }
    li.checked > .name, li.checked .name {
      font-weight: normal !important;
      color: #444 !important;
      background: transparent !important;
    }
    .counter{
      display:flex;
      align-items:center;
      gap:7px;
      font-size:1.02rem;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      user-select: none;
    }
    .counter button{
      width:22px;
      height:22px;
      border:none;
      border-radius:50%;
      color:#fff;
      font-size:1.01rem;
      cursor:pointer;
      background-color:#bbb;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      user-select: none;
    }
    .counter span.count{
      min-width:19px;
      text-align:center;
      font-size:1.03rem;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      user-select: none;
    }
    .add-table-btn-wrap {
      width: 100%;
      display: flex;
      justify-content: flex-start;
      margin: 42px 0 0 0;
    }
    .add-table-btn {
      position: static;
      margin-left: 0;
      background: #009688;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.3rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.13);
      cursor: pointer;
      font-weight: 700;
      transition: background 0.18s, box-shadow 0.18s;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.82;
    }
    .add-table-btn:hover {
      background: #00796b;
      box-shadow: 0 4px 20px rgba(0,0,0,0.18);
      opacity: 1;
    }
    .add-table-btn::after {
      content: attr(data-tooltip);
      opacity: 0;
      pointer-events: none;
      background: #222;
      color: #fff;
      padding: 3px 9px;
      border-radius: 5px;
      font-size: 0.88rem;
      white-space: nowrap;
      position: absolute;
      left: 120%;
      top: 50%;
      transform: translateY(-50%);
      transition: opacity 0.2s;
      z-index: 1001;
    }
    .add-table-btn:hover::after {
      opacity: 0.95;
    }
    @media(max-width:600px){
      .header{font-size:0.95rem;}
      .header-title{font-size:1rem;}
      .name{font-size:0.98rem;}
      .header-count{font-size:0.97rem;padding:2px 7px;}
      .header-check{font-size:1.02rem;padding:2px 7px;}
      .reset-btn-float{padding:7px 10px;font-size:0.9rem;}
      .add-table-btn{width:26px;height:26px;font-size:0.99rem;}
      li{font-size:0.96rem;}
      .counter{font-size:0.95rem;}
      .counter span.count{font-size:0.98rem;}
    }
    li.checked {
      background: #e0e0e0 !important;
      color: #444 !important;
    }
    li.checked.has-count > .name, li.checked.has-count .name {
      font-weight: bold !important;
      color: #444 !important;
      background: transparent !important;
      text-decoration: line-through !important;
    }
    li.checked:not(.has-count) > .name,
    li.checked:not(.has-count) .name {
      font-weight: normal !important;
      color: #444 !important;
      background: transparent !important;
      text-decoration: line-through !important;
    }
    li.checked > .name, li.checked .name {
      text-decoration: line-through !important;
    }
    li.has-count:not(.checked) > .name, li.has-count:not(.checked) .name {
      font-weight: bold !important;
      color: #222 !important;
      background: #fff59d !important;
      border-radius: 5px !important;
      padding: 2px 8px !important;
      font-size: 1.09rem !important;
      letter-spacing: 0.01em !important;
      transition: background 0.15s, color 0.15s;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      text-decoration: none !important;
    }
  </style>
</head>
</head>
<body>
  <div id="login-section" style="text-align:center;margin-top:50px;">
    <h2>Login to Grocery List</h2>
    <button id="google-signin-btn" style="font-size:1.1rem;padding:10px 22px;background:#4285F4;color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:600;">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="height:1.25em;vertical-align:middle;margin-right:6px;">
      Sign in with Google
    </button>
    <div id="login-error" style="color:red;margin:10px;"></div>
  </div>
  <div id="main-section" style="display:none;">
    <button id="logout-btn" title="Logout" onclick="logout()">
      <svg width="16" height="16" viewBox="0 0 20 20" style="vertical-align:middle;"><path fill="#5b5b5b" d="M3 2a2 2 0 0 1 2-2h5a2 2 0 0 1 2 2v3h-2V2H5v16h5v-3h2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V2zm11.29 7.29l-1.3 1.3a1 1 0 1 0 1.42 1.42l3-3a1 1 0 0 0 0-1.42l-3-3a1 1 0 0 0-1.42 1.42l1.3 1.3H9a1 1 0 1 0 0 2h5.59z"/></svg>
    </button>
    <button class="reset-btn-float" onclick="resetAll()" title="Reset counters and uncheck all">Reset All</button>
    <h1>Kumar Family Grocery</h1>
    <div class="datetime" id="datetime"></div>
    <div id="tables-area"></div>
    <div class="add-table-btn-wrap">
      <button class="add-table-btn" onclick="addNewTablePrompt()" data-tooltip="Add Table" title="Add Table">ï¼‹</button>
    </div>
  </div>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyADHt2ZI5eCYLWs9hA16WJaL16C8REHbMI",
      authDomain: "kumar-grocery-list.firebaseapp.com",
      databaseURL: "https://kumar-grocery-list-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kumar-grocery-list",
      storageBucket: "kumar-grocery-list.appspot.com",
      messagingSenderId: "726095302244",
      appId: "1:726095302244:web:afacaef92680ad26151971",
      measurementId: "G-MC9K47NDW6"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Verify initialization
    console.log("Firebase apps:", firebase.apps);
    
    // Define ALLOWED_USERS as an array of allowed email addresses
    const ALLOWED_USERS = [
      "sunil.kumar101@gmail.com",
      "manju4sun@gmail.com"
    ];

    let CATEGORIES = [
      'veggies',
      'grocery',
      'indian',
      'kmart_bigw_target',
      'pharmacy',
      'others'
    ];

    let CATEGORY_NAMES = {
      veggies: 'Veggies',
      grocery: 'Grocery',
      indian: 'India Store',
      kmart_bigw_target: 'Kmart/Big W/Target',
      pharmacy: 'Pharmacy',
      others: 'Others'
    };

    let CATEGORY_ICONS = {
      veggies: 'ðŸ¥¦',
      grocery: 'ðŸ›’',
      indian: '<img src="https://upload.wikimedia.org/wikipedia/en/4/41/Flag_of_India.svg" alt="India" style="height:1.3em;vertical-align:middle;margin-right:4px;">',
      kmart_bigw_target: '',
      pharmacy: '',
      others: ''
    };

    let CATEGORY_HEADER_CLASSES = {
      veggies: 'veggies-header',
      grocery: 'grocery-header',
      indian: 'indian-header',
      kmart_bigw_target: 'kmart_bigw_target-header',
      pharmacy: 'pharmacy-header',
      others: 'others-header'
    };

    let groceryData = {};
    let listeners = [];

    // Google Auth
    function googleSignIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          if (ALLOWED_USERS.length && !ALLOWED_USERS.includes(user.email)) {
            auth.signOut();
            document.getElementById('login-error').textContent = 'Access denied. Please use an allowed Google account.';
            return;
          }
          showMain();
          subscribeAllLists();
        })
        .catch((err) => {
          document.getElementById('login-error').textContent = err.message;
        });
    }

    document.getElementById('google-signin-btn').onclick = googleSignIn;

    function logout() {
      listeners.forEach(fn => {try {fn();}catch(e){}});
      listeners = [];
      auth.signOut();
      location.reload();
    }
    function showMain() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('main-section').style.display = '';
      CATEGORIES.forEach(cat=>{
        if(localStorage.getItem('col-'+cat)==='true') setCollapsed(cat,true);
      });
    }
    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent =
        now.toLocaleString('en-AU', {weekday:'long',year:'numeric',month:'short',day:'numeric', hour:'2-digit',minute:'2-digit', second:'2-digit', hour12:true});
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Listeners
    function subscribeAllLists() {
      listeners.forEach(fn => {try {fn();}catch(e){}});
      listeners = [];

      db.ref(`/groceryLists`).on('value', snap => {
        const data = snap.val() || {};
        groceryData = data;
        let allKeys = Object.keys(data);
        let ordered = [];
        CATEGORIES.forEach(cat => { if(allKeys.includes(cat)) ordered.push(cat); });
        allKeys.forEach(cat=>{
          if(!ordered.includes(cat)) ordered.push(cat);
        });
        CATEGORIES = ordered;
        renderAllTables();
      });

      CATEGORIES.forEach(cat => {
        const ref = db.ref(`/groceryLists/${cat}`);
        const fn = ref.on('value', snap => {
          groceryData[cat] = snap.val() || {};
          renderList(cat);
          updateHeaderCount(cat);
        });
        listeners.push(() => ref.off('value', fn));
      });
    }

    // ... [ALL RENDERING AND LOGIC FUNCTIONS UNCHANGED FROM ORIGINAL CODE] ...

    function renderAllTables() {
      const area = document.getElementById('tables-area');
      area.innerHTML = '';
      CATEGORIES.forEach(cat => {
        if (!CATEGORY_NAMES[cat]) CATEGORY_NAMES[cat] = cat.charAt(0).toUpperCase() + cat.slice(1);
        if (!CATEGORY_ICONS[cat]) CATEGORY_ICONS[cat] = '';
        const container = document.createElement('div');
        container.className = 'container';
        container.id = `${cat}-container`;

        const header = document.createElement('div');
        header.className = 'header ' + (CATEGORY_HEADER_CLASSES[cat] || 'default-header');
        header.id = `${cat}-header`;
        header.onclick = ()=>toggleCollapse(cat);

        const headerTitle = document.createElement('span');
        headerTitle.className = 'header-title';
        headerTitle.innerHTML = (CATEGORY_ICONS[cat] ? CATEGORY_ICONS[cat] + " " : "") + CATEGORY_NAMES[cat];

        const headerCount = document.createElement('span');
        headerCount.className = 'header-count';
        headerCount.id = `${cat}-count`;

        const headerArrow = document.createElement('span');
        headerArrow.className = 'collapse-arrow';
        headerArrow.id = `${cat}-arrow`;
        headerArrow.innerHTML = "&#9654;";

        header.appendChild(headerTitle);
        header.appendChild(headerCount);
        header.appendChild(headerArrow);

        container.appendChild(header);

        const ul = document.createElement('ul');
        ul.id = cat;
        container.appendChild(ul);

        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = 'ï¼‹';
        addBtn.onclick = (e)=>{
          e.stopPropagation();
          addItem(cat);
        };
        container.appendChild(addBtn);

        area.appendChild(container);

        if(localStorage.getItem('col-'+cat)==='true') setCollapsed(cat,true);

        renderList(cat);
        updateHeaderCount(cat);
      });
    }

    function toggleCollapse(cat) {
      const ul = document.getElementById(cat);
      const addBtn = document.querySelector(`#${cat}-container .add-btn`);
      const container = document.getElementById(cat+'-container');
      let collapsed = ul.style.display!=='none';
      setCollapsed(cat, collapsed);
      localStorage.setItem('col-'+cat, collapsed?'true':'');
    }
    function setCollapsed(cat, collapsed) {
      const ul = document.getElementById(cat);
      const addBtn = document.querySelector(`#${cat}-container .add-btn`);
      const container = document.getElementById(cat+'-container');
      ul.style.display = collapsed?'none':'';
      addBtn.style.display = collapsed?'none':'';
      container.classList.toggle('collapsed', collapsed);
    }

    function renderList(cat) {
      const ul = document.getElementById(cat);
      if (!ul) return;
      ul.innerHTML = '';
      const items = groceryData[cat] || {};
      Object.entries(items).forEach(([key, item]) => {
        if (!item || typeof item !== 'object' || typeof item.name !== 'string') return;
        const li = document.createElement('li');
        li.setAttribute('draggable', 'false');
        if(item.checked) li.classList.add('checked');
        if(item.count > 0) li.classList.add('has-count');
        li.style.position = 'relative';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!item.checked;
        cb.onchange = () => toggleChecked(cat, key, cb.checked);
        li.appendChild(cb);

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = item.name;
        name.ondblclick = (e) => {
          e.stopPropagation();
          editNameInline(cat, key, name, item);
        };
        li.appendChild(name);

        const cnt = document.createElement('div');
        cnt.className = 'counter';
        const minus = document.createElement('button');
        minus.textContent = '-';
        minus.onclick = (e) => {
          e.stopPropagation();
          updateCount(cat, key, -1);
        };
        const count = document.createElement('span');
        count.className = 'count';
        count.textContent = item.count || 0;
        const plus = document.createElement('button');
        plus.textContent = '+';
        plus.onclick = (e) => {
          e.stopPropagation();
          updateCount(cat, key, +1);
        };
        cnt.appendChild(minus);
        cnt.appendChild(count);
        cnt.appendChild(plus);
        li.appendChild(cnt);

        ul.appendChild(li);
      });
    }

    function addItem(cat) {
      const name = prompt('Enter new item name:');
      if(!name || !name.trim()) return;
      db.ref(`/groceryLists/${cat}`).push({name: name.trim(), count: 0, checked: false});
    }

    function addNewTablePrompt() {
      let tname = prompt('Enter table name (e.g. Pharmacy):');
      if(!tname || !tname.trim()) return;
      tname = tname.trim();
      let catKey = tname.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
      if (!catKey) catKey = 'custom_' + Date.now();
      if(CATEGORIES.includes(catKey)) {
        alert('Table already exists!');
        return;
      }
      let items = {};
      if(confirm('Do you want to add an item to this table now?')) {
        let itemName = prompt('Enter item name:');
        if(itemName && itemName.trim()) {
          items = {[db.ref().push().key]: {name:itemName.trim(), count:0, checked:false}};
        }
      }
      CATEGORY_NAMES[catKey] = tname;
      CATEGORY_ICONS[catKey] = '';
      CATEGORY_HEADER_CLASSES[catKey] = 'default-header';
      db.ref(`/groceryLists/${catKey}`).set(items);
    }

    function updateCount(cat, key, delta) {
      const item = groceryData[cat][key];
      if (!item || typeof item !== 'object' || typeof item.name !== 'string') return;
      let v = (item.count || 0) + delta;
      v = Math.max(0, Math.min(50, v));
      db.ref(`/groceryLists/${cat}/${key}`).update({ count: v });
    }

    function toggleChecked(cat, key, val) {
      db.ref(`/groceryLists/${cat}/${key}`).update({ checked: !!val });
    }

    function editNameInline(cat, key, nameDiv, oldItem) {
      if(nameDiv.classList.contains('editing')) return;
      const prevName = oldItem.name;
      nameDiv.classList.add('editing');
      nameDiv.setAttribute('contenteditable', 'true');
      nameDiv.setAttribute('spellcheck', 'false');
      nameDiv.style.userSelect = "text";
      nameDiv.focus();
      nameDiv.setSelectionRange && nameDiv.setSelectionRange(prevName.length, prevName.length);

      let finished = false;

      function finishEdit() {
        if (finished) return;
        finished = true;
        nameDiv.classList.remove('editing');
        nameDiv.removeAttribute('contenteditable');
        nameDiv.style.userSelect = "";
        const newValue = nameDiv.textContent.trim();
        if (!newValue) {
          db.ref(`/groceryLists/${cat}/${key}`).update({ name: prevName });
          nameDiv.textContent = prevName;
        } else if (newValue !== prevName) {
          db.ref(`/groceryLists/${cat}/${key}`).update({ name: newValue });
        }
      }
      nameDiv.onkeydown = function(e) {
        if (e.key === "Enter") { e.preventDefault(); finishEdit(); }
        if (e.key === "Escape") { nameDiv.textContent = prevName; finishEdit(); }
      };
      nameDiv.onblur = finishEdit;
    }

    function resetAll() {
      if(!confirm("Reset all counters to 0 and uncheck all items in all tables?")) return;
      CATEGORIES.forEach(cat=>{
        const items = groceryData[cat] || {};
        Object.entries(items).forEach(([key, item]) => {
          db.ref(`/groceryLists/${cat}/${key}`).update({count:0, checked:false});
        });
      });
    }

    function updateHeaderCount(cat){
      const items = groceryData[cat] || {};
      const count = Object.values(items).filter(x=>x && typeof x === "object" && !x.checked && x.count>0).length;
      const el = document.getElementById(cat+'-count');
      if(!el) return;
      if(count>0) {
        el.textContent = count;
        el.className = 'header-count';
      } else {
        el.innerHTML = '<span class="header-check">&#10003;</span>';
        el.className = '';
      }
    }

    auth.onAuthStateChanged(user => {
      if (user && (!ALLOWED_USERS.length || ALLOWED_USERS.includes(user.email))) {
        showMain();
        subscribeAllLists();
      } else {
        document.getElementById('main-section').style.display = 'none';
        document.getElementById('login-section').style.display = '';
      }
    });
  </script>
</body>
</html>
